# REST API Plan

## 1. Resources
- **Flashcards** – corresponds to the `flashcards` table.
- **Generations** – corresponds to the `generations` table.
- **GenerationErrorLogs** – corresponds to the `generation_error_logs` table.
- **Users** – managed externally by Supabase Auth (referenced in all tables via `user_id`).

## 2. Endpoints

### Flashcards
1. **List User Flashcards**
   - **Method:** GET
   - **URL:** `/api/flashcards`
   - **Description:** Retrieve a paginated list of flashcards for the current user.
   - **Query Parameters:** 
     - `page` (integer, optional): Page number.
     - `limit` (integer, optional): Number of flashcards per page.
     - `search` (string, optional): Search query for filtering flashcards by content.
     - `sortBy` (string, optional): Field to sort by (e.g., `created_at`).
     - `order` (string, optional): `asc` or `desc`.
   - **Response Example:**
     ```json
     {
       "data": [
         {
           "id": 123,
           "front": "Sample question",
           "back": "Sample answer",
           "source": "ai-full",
           "status": true,
           "created_at": "2023-10-01T12:00:00Z",
           "updated_at": "2023-10-01T12:00:00Z",
           "generation_id": 45,
           "user_id": "uuid-string"
         }
       ],
       "pagination": {
         "page": 1,
         "limit": 10,
         "total": 50
       }
     }
     ```
   - **Success Codes:** 200 OK
   - **Error Codes:** 401 Unauthorized, 500 Internal Server Error

2. **Create Flashcard (Manual or Accepted AI)**
   - **Method:** POST
   - **URL:** `/api/flashcards`
   - **Description:** Create new flashcards via bulk creation. This endpoint always accepts a JSON object with a required property `"flashcards"`, which must be a non-empty array. It is used both for manual flashcard creation and for saving flashcards generated by AI (full and edited).
   - **Request Body:**  
     The request body must be an object containing a `"flashcards"` array with at least one flashcard object. For example:
     ```json
     {
       "flashcards": [
         {
           "front": "Flashcard front text (max 200 characters)",
           "back": "Flashcard back text (max 500 characters)",
           "source": "manual", // or one of: "ai-full", "ai-edited"
           "generation_id": 45  // optional if applicable
         }
       ]
     }
     ```
   - **Validation:**  
     - The `"flashcards"` array must not be empty.
     - Each flashcard object must include:
       - A `"front"` string with a maximum length of 200 characters.
       - A `"back"` string with a maximum length of 500 characters.
       - A `"source"` string that is either `"manual"`, `"ai-full"`, or `"ai-edited"`.
       - Optionally, a `"generation_id"` which, if provided, should be a positive integer.
     - The server should enforce these limits and return a **400 Bad Request** if any validation constraint is violated.
   - **Response Example:**  
     The API returns an array of created flashcard objects:
     ```json
     [
       {
         "id": 124,
         "front": "Flashcard front text",
         "back": "Flashcard back text",
         "source": "manual",
         "status": true,
         "created_at": "2023-10-03T15:00:00Z",
         "updated_at": "2023-10-03T15:00:00Z",
         "generation_id": null,
         "user_id": "uuid-string"
       }
     ]
     ```
   - **Success Codes:** 201 Created
   - **Error Codes:** 400 Bad Request (if validation fails or if `"flashcards"` is missing or empty), 401 Unauthorized, 500 Internal Server Error

3. **Update Flashcard (Editing by User)**
   - **Method:** PUT
   - **URL:** `/api/flashcards/{flashcardId}`
   - **Description:** Update an existing flashcard.
   - **URL Parameter:** 
     - `flashcardId` (integer): ID of the flashcard.
   - **Request Body:**
     ```json
     {
       "front": "Updated front text",
       "back": "Updated back text"
     }
     ```
   - **Response Example:**
     ```json
     {
       "id": 124,
       "front": "Updated front text",
       "back": "Updated back text",
       "source": "manual",
       "status": true,
       "created_at": "2023-10-03T15:00:00Z",
       "updated_at": "2023-10-03T15:05:00Z",
       "generation_id": null,
       "user_id": "uuid-string"
     }
     ```
   - **Success Codes:** 200 OK
   - **Error Codes:** 400 Bad Request, 401 Unauthorized, 404 Not Found, 500 Internal Server Error
    - **Validation:**
     - Each flashcard object must include:
       - A `"front"` string with a maximum length of 200 characters.
       - A `"back"` string with a maximum length of 500 characters.
       - A `"source"` string that is either `"manual"`, or `"ai-edited"`.

4. **Delete Flashcard**
   - **Method:** DELETE
   - **URL:** `/api/flashcards/{flashcardId}`
   - **Description:** Soft-delete (or mark inactive) a flashcard.
   - **URL Parameter:** 
     - `flashcardId` (integer): ID of the flashcard.
   - **Response Example:**
     ```json
     {
       "message": "Flashcard deleted successfully"
     }
     ```
   - **Success Codes:** 200 OK
   - **Error Codes:** 401 Unauthorized, 404 Not Found, 500 Internal Server Error

5. **Get Flashcard Details**
   - **Method:** GET
   - **URL:** `/api/flashcards/{flashcardId}`
   - **Description:** Retrieve the details of a single flashcard by its ID.
   - **URL Parameter:** 
     - `flashcardId` (integer): ID of the flashcard.
   - **Response Example:**
     ```json
     {
       "id": 124,
       "front": "Sample flashcard front text",
       "back": "Sample flashcard back text",
       "source": "manual",
       "status": true,
       "created_at": "2023-10-03T15:00:00Z",
       "updated_at": "2023-10-03T15:05:00Z",
       "generation_id": null,
       "user_id": "uuid-string"
     }
     ```
   - **Success Codes:** 200 OK
   - **Error Codes:** 401 Unauthorized, 404 Not Found, 500 Internal Server Error

### Generations
1. **List AI Generation Sessions**
   - **Method:** GET
   - **URL:** `/api/generations`
   - **Description:** Retrieve a list of AI generation sessions for the current user.
   - **Query Parameters:** Pagination and filtering parameters similar to flashcards.
   - **Response Example:**
     ```json
     {
       "data": [
         {
           "id": 45,
           "user_id": "uuid-string",
           "ai_model": "openai/gpt-4",
           "generated_count": 10,
           "accepted_unedited_count": 5,
           "accepted_edited_count": 2,
           "source_text_hash": "abc123",
           "source_text_length": 1500,
           "generation_duration": 120,
           "created_at": "2023-10-02T12:00:00Z",
           "updated_at": "2023-10-02T12:05:00Z"
         }
       ],
       "pagination": {
         "page": 1,
         "limit": 10,
         "total": 20
       }
     }
     ```
   - **Success Codes:** 200 OK
   - **Error Codes:** 401 Unauthorized, 500 Internal Server Error

2. **Create a New AI Generation Session**
   - **Method:** POST
   - **URL:** `/api/generations`
   - **Description:** Create a new generation session when a user submits a text to generate flashcard proposals.
   - **Request Body:**
     ```json
     {
       "source_text": "User submitted text"
     }
     ```
   - **Response Example:**
     ```json
     {
       "id": 45,
       "user_id": "uuid-string",
       "generated_count": 10,
       "flashcards_proposals": [
         {
           "id": 2,
           "front": "front text",
           "back": "back text",
           "source": "ai-full"
         }
       ]
     }
     ```
   - **Success Codes:** 201 Created
   - **Error Codes:** 400 Bad Request, 401 Unauthorized, 500 Internal Server Error 
   (Note: In case of a generation error, information is automatically logged to the generation_error_logs table.)
   - **Validation:** The request body must include a "source_text" string with a length between 1000 and 10000 characters.

### GenerationErrorLogs
1. **List Generation Error Logs**
   - **Method:** GET
   - **URL:** `/api/generation-error-logs`
   - **Description:** Retrieve a list of error logs related to AI generation sessions for the current user.
   - **Query Parameters:** Pagination similar to other resources.
   - **Response Example:**
     ```json
     {
       "data": [
         {
           "id": 5,
           "user_id": "uuid-string",
           "ai_model": "openai/gpt-4",
           "source_text_hash": "hash-value",
           "source_text_length": 1500,
           "error_code": "ERR_001",
           "error_message": "Failure message",
           "created_at": "2023-10-02T12:30:00Z"
         }
       ],
       "pagination": {
         "page": 1,
         "limit": 10,
         "total": 5
       }
     }
     ```
   - **Success Codes:** 200 OK
   - **Error Codes:** 401 Unauthorized, 403 Forbidden, 500 Internal Server Error

## 4. Validation and Business Logic

### Validation Rules (from Database Schema)
- **Flashcards:**
  - `front` text length must be ≤ 200 characters.
  - `back` text length must be ≤ 500 characters.
  - `status` must be a boolean.
- **Generations & GenerationErrorLogs:**
  - `source_text` must be between 1000 and 10000.
  - Data integrity enforced via CHECK constraints and proper foreign key relationships.
  
### Business Logic Mapping (from PRD)
- **AI-Generated Flashcards Review**
  - Users submit a text (1000 to 10000 characters) which triggers an AI generation session (POST `/api/generations`).
  - If the generation ends in error, an entry is automatically added to the generation_error_logs.
  - Only accepted flashcards are persisted.
- **Manual Creation of Flashcards**
  - Users can create flashcards manually (POST `/api/flashcards`) through a straightforward form.
- **Flashcards Management**
  - Endpoints support listing (with pagination, filtering, and sorting), updating, and deleting flashcards.
  - Editing endpoints validate against length constraints.